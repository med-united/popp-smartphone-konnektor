package de.gematik.ws.conn.vsds.vsdservice.v5_2;

import java.io.ByteArrayInputStream;
import java.io.OutputStreamWriter;
import java.net.URI;

import org.eclipse.microprofile.config.inject.ConfigProperty;

import de.gematik.ws.conn.vsds.vsdservice.v5.ReadVSD;
import de.gematik.ws.conn.vsds.vsdservice.v5.ReadVSDResponse;
import jakarta.json.Json;

/**
 * This class was generated by Apache CXF 4.1.4
 * 2026-02-02T22:57:04.219+01:00
 * Generated source version: 4.1.4
 *
 */
@jakarta.jws.WebService(
                      serviceName = "VSDService",
                      portName = "VSDServicePort",
                      targetNamespace = "http://ws.gematik.de/conn/vsds/VSDService/v5.2",
                      wsdlLocation = "classpath:/wsdl/VSDService.wsdl",
                      endpointInterface = "de.gematik.ws.conn.vsds.vsdservice.v5_2.VSDServicePortType")

public class VSDServicePortImpl implements VSDServicePortType {


    private static final java.util.logging.Logger LOG = java.util.logging.Logger.getLogger(VSDServicePortImpl.class.getName());

    @ConfigProperty(name = "popp.client-url", defaultValue = "http://localhost:8081")
    String poppClientUrl;

    @Override
    public ReadVSDResponse readVSD(ReadVSD parameter) throws FaultMessage {
        LOG.info("Executing operation readVSD");
        ReadVSDResponse _return = new ReadVSDResponse();

        // Do GET call to PoPP client to trigger PoPP Token dance
        // https://github.com/gematik/popp-sample-code/blob/main/popp-client/src/main/java/de/gematik/refpopp/popp_client/controller/CardRestController.java
        URI uri = URI.create(poppClientUrl + "/token");
        try {
            java.net.HttpURLConnection conn = (java.net.HttpURLConnection) uri.toURL().openConnection();
            conn.setRequestMethod("POST");
            conn.setDoOutput(true);
            conn.setDoInput(true);
            conn.setRequestProperty("Accept", "application/json");
            conn.setRequestProperty("Content-Type", "application/json");
            conn.setConnectTimeout(30000);
            conn.setReadTimeout(30000);
            OutputStreamWriter wr = new OutputStreamWriter(conn.getOutputStream());
            wr.write("{" +
                "\"communicationType\": \"contact-connector\"," +
                "\"clientSessionId\": \""+parameter.getEhcHandle()+"\"" +
            "}");
            wr.flush(); 
            int responseCode = conn.getResponseCode();
            LOG.info("POST " + uri + " response code: " + responseCode);
            java.io.InputStream is = (responseCode >= 200 && responseCode < 300) ? conn.getInputStream() : conn.getErrorStream();
            java.util.Scanner scanner = new java.util.Scanner(is).useDelimiter("\\A");
            String poppJson = scanner.hasNext() ? scanner.next() : "";
            String poppToken = Json.createReader(new ByteArrayInputStream(poppJson.getBytes())).readObject().getString("token");
            LOG.info("Response body: " + poppToken);
            scanner.close();
            is.close();
            _return.setPruefungsnachweis(poppToken.getBytes());
        } catch (Exception e) {
            LOG.severe("POST request to " + uri + " failed: " + e.getMessage());
        }

        return _return;
    }
}
